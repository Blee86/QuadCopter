//
//  Wrapper Class of AHRS(vn-100), Pololu, and PID. It's basically Fight controller.
//  Checks Gyro values from AHRS(vn-100), and it runs PID and controls motors(x,y axis)
//  Additionally, It logs pid value and gyro values; x, y, z
//
//  Created by Yosub Lee on 7/23/14.
//  Copyright (c) 2014 Yosub Lee. All rights reserved.
///////////////////////////////////////////////////

//  Note //////////////////////////////////////////
// Log file is using CSV format
//

#ifndef FanControl__H
#define FanControl__H

#include <iostream>
#include <thread> 
#include <fstream>
#include <sys/stat.h>
#include <fcntl.h>
#include <ctime>
#include <chrono>

#include "FanControl.h"
#include "pololuMaestroMotorController.h"
#include "fan.h"
#include "PID_Yo.h"
#include "vndevice.h"
#include "vn100.h"

using namespace std;

class FanControl {
public:
	FanControl(int BAUD_RATE = 115200);
	~FanControl();
	void loggingOn();
	void finishLogging();
	void setMotorSpeedAll(int speed);
	
	//PID settings
	void setOutputLimitsX(int min, int max);
	void setOutputLimitsY(int min, int max);
	void setPidGainsX(int p, int i, int d);
	void setPidGainsY(int p, int i, int d);
	void setPointPidX(int point);
	void setPointPidY(int point);
	
	
	void start();
	void stop();
private:   
	void initVN100();
	void initFanController();
	void writeLog();
	void computePID();
	void controlMotors();
	void setMotorSpeed();
	void setPID();
	
	// Variables
	bool logging;
	bool running;
	volatile double m_outputX, m_outputY, m_outputZ;
        int BAUD_RATE;
        float sampleRate;
        int baseSpeed, maxSpeed, minSpeed;
        
	PID *pid_X;         // Pitch
	PID *pid_Y;         // Roll
	PID *pid_Z;         // Yaw
	string pololuPath;
	Vn100 *vn100;
	VnYpr *ypr;
	PololuMaestroMotorController *motorController;
	FanController *fanController;
	ofstream *Log;    
	chrono::time_point<std::chrono::high_resolution_clock> m_now, m_lastTime;
	
	//temporary. Thread testing
	thread pidThread;
};

#endif /* defined(__FanControl__H) */
